<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YMK Catering - Operasyon Haritası</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #1e40af;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            --text-dark: #0f172a;
            --text-gray: #475569;
            --border: #e2e8f0;
        }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        #sidebar {
            width: 380px;
            background: white;
            border-right: 2px solid var(--border);
            padding: 24px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .brand h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 4px;
        }
        
        .subtitle {
            font-size: 14px;
            font-weight: 600;
            color: var(--success);
            display: block;
            margin-bottom: 24px;
        }
        
        .back-btn {
            width: 100%;
            padding: 12px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: 0.2s;
        }
        
        .back-btn:hover {
            background: #1e3a8a;
            transform: translateY(-2px);
        }
        
        .hidden { display: none !important; }
        
        .status-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .status-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-gray);
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        
        .status-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 12px;
        }
        
        .city-card {
            padding: 16px 18px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            margin: 8px 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .city-card:hover {
            background: #dbeafe;
            border-color: var(--primary);
            transform: translateX(6px);
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.15);
        }
        
        .city-card::after {
            content: '→';
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .legend-card {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
        }
        
        .legend-title {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dark);
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
            font-size: 14px;
            color: var(--text-gray);
        }
        
        .legend-dot {
            width: 28px;
            height: 20px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        #map {
            flex: 1;
            background: #e0f2fe;
        }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content {
            margin: 16px;
            font-family: inherit;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            background: white;
            padding: 30px 40px;
            border-radius: 16px;
            text-align: center;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 40%; border-right: none; border-bottom: 2px solid var(--border); }
            #map { height: 60%; }
        }
    </style>
</head>
<body>

<aside id="sidebar">
    <header class="brand">
        <h1>YMK Catering</h1>
        <span class="subtitle">Tüm Türkiye Operasyon Haritası</span>
    </header>

    <button id="backButton" class="back-btn hidden">← Türkiye Geneli</button>

    <div class="status-card">
        <div class="status-label">Sistem Durumu</div>
        <div id="systemStatus" class="status-value">Başlatılıyor...</div>
    </div>

    <div>
        <h2 class="section-title">Aktif Şehirler</h2>
        <div id="cityList">
            <div style="text-align:center; padding:40px; color:#94a3b8;">Yükleniyor...</div>
        </div>
    </div>

    <div class="legend-card">
        <h3 class="legend-title">Minimum Sipariş Limitleri</h3>
        <div>
            <div class="legend-item">
                <span class="legend-dot" style="background:#22c55e"></span>
                <span>0-15 kişi (Yüksek esneklik)</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot" style="background:#f59e0b"></span>
                <span>16-50 kişi (Orta esneklik)</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot" style="background:#ef4444"></span>
                <span>51+ kişi (Toplu hizmet)</span>
            </div>
        </div>
    </div>
</aside>

<main id="map"></main>

<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <div style="font-weight:600; color:#1e293b;">Harita yükleniyor...</div>
    </div>
</div>

<script>
// ============================================
// YAPILANDIRMA
// ============================================
const CONFIG = {
    SHEET_URL: 'https://docs.google.com/spreadsheets/d/14v85yx696A2-5L3WWc5LTnBCwc6esA68Roh8Wo7uleI/gviz/tq?tqx=out:csv',
    
    // TÜRKİYE GEOJSON KAYNAKLARI (Sırayla denenecek)
    GEOJSON_SOURCES: [
        'https://raw.githubusercontent.com/alpakih/turkey-geojson/master/json/turkey-district.json',
        'https://raw.githubusercontent.com/mrtysn/turkey-geojson/master/turkey-districts.json',
        'turkiye-ilceler.json' // Kendi dosyan varsa
    ],
    
    MAP_CENTER: [39.0, 35.0],
    MAP_ZOOM: 6,
    COLORS: {
        LOW: '#22c55e',
        MEDIUM: '#f59e0b',
        HIGH: '#ef4444',
        NO_DATA: '#cbd5e1'
    }
};

// ============================================
// GLOBAL DEĞİŞKENLER
// ============================================
let map = null;
let currentLayer = null;
let allData = [];
let turkeyGeoJSON = null; // MASTER GEOJSON (Tüm Türkiye)

// ============================================
// ŞEHİR - PLAKA EŞLEŞTİRME
// ============================================
const CITY_PLATE_MAP = {
    'adana': '01', 'adiyaman': '02', 'afyonkarahisar': '03', 'agri': '04',
    'amasya': '05', 'ankara': '06', 'antalya': '07', 'artvin': '08',
    'aydin': '09', 'balikesir': '10', 'bilecik': '11', 'bingol': '12',
    'bitlis': '13', 'bolu': '14', 'burdur': '15', 'bursa': '16',
    'canakkale': '17', 'cankiri': '18', 'corum': '19', 'denizli': '20',
    'diyarbakir': '21', 'edirne': '22', 'elazig': '23', 'erzincan': '24',
    'erzurum': '25', 'eskisehir': '26', 'gaziantep': '27', 'giresun': '28',
    'gumushane': '29', 'hakkari': '30', 'hatay': '31', 'isparta': '32',
    'mersin': '33', 'istanbul': '34', 'izmir': '35', 'kars': '36',
    'kastamonu': '37', 'kayseri': '38', 'kirklareli': '39', 'kirsehir': '40',
    'kocaeli': '41', 'konya': '42', 'kutahya': '43', 'malatya': '44',
    'manisa': '45', 'kahramanmaras': '46', 'mardin': '47', 'mugla': '48',
    'mus': '49', 'nevsehir': '50', 'nigde': '51', 'ordu': '52',
    'rize': '53', 'sakarya': '54', 'samsun': '55', 'siirt': '56',
    'sinop': '57', 'sivas': '58', 'tekirdag': '59', 'tokat': '60',
    'trabzon': '61', 'tunceli': '62', 'sanliurfa': '63', 'usak': '64',
    'van': '65', 'yozgat': '66', 'zonguldak': '67', 'aksaray': '68',
    'bayburt': '69', 'karaman': '70', 'kirikkale': '71', 'batman': '72',
    'sirnak': '73', 'bartin': '74', 'ardahan': '75', 'igdir': '76',
    'yalova': '77', 'karabuk': '78', 'kilis': '79', 'osmaniye': '80',
    'duzce': '81'
};

// ============================================
// YARDIMCI FONKSİYONLAR
// ============================================
function normalize(text) {
    if (!text) return '';
    return text.toString().toLowerCase().trim()
        .replace(/ğ/g, 'g').replace(/ü/g, 'u').replace(/ş/g, 's')
        .replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ç/g, 'c')
        .replace(/[^a-z0-9]/g, '');
}

function getColor(limit) {
    const num = parseInt(limit);
    if (num <= 15) return CONFIG.COLORS.LOW;
    if (num <= 50) return CONFIG.COLORS.MEDIUM;
    return CONFIG.COLORS.HIGH;
}

function updateStatus(message, color = '#f59e0b') {
    const el = document.getElementById('systemStatus');
    if (el) {
        el.textContent = message;
        el.style.color = color;
    }
}

function showLoading(show = true) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.classList.toggle('hidden', !show);
    }
}

function log(message, type = 'info') {
    const colors = {
        info: '#3b82f6',
        success: '#22c55e',
        error: '#ef4444',
        warn: '#f59e0b'
    };
    console.log(`%c[YMK] ${message}`, `color: ${colors[type]}; font-weight: bold`);
}

// ============================================
// MASTER GEOJSON YÜKLEME (TEK SEFER)
// ============================================
async function loadTurkeyGeoJSON() {
    if (turkeyGeoJSON) {
        log('GeoJSON zaten yüklü (cache)', 'info');
        return turkeyGeoJSON;
    }
    
    log('Türkiye GeoJSON yükleniyor...', 'info');
    showLoading(true);
    
    // Sırayla kaynakları dene
    for (const source of CONFIG.GEOJSON_SOURCES) {
        try {
            log(`Deneniyor: ${source}`, 'info');
            const response = await fetch(source);
            
            if (!response.ok) continue;
            
            turkeyGeoJSON = await response.json();
            log('GeoJSON başarıyla yüklendi!', 'success');
            showLoading(false);
            return turkeyGeoJSON;
            
        } catch (error) {
            log(`${source} başarısız: ${error.message}`, 'warn');
            continue;
        }
    }
    
    showLoading(false);
    throw new Error('Hiçbir GeoJSON kaynağı yüklenemedi');
}

// ============================================
// ŞEHİR FİLTRELEME
// ============================================
function filterGeoJSONByCity(cityName) {
    if (!turkeyGeoJSON) return null;
    
    const cityKey = normalize(cityName);
    const plateCode = CITY_PLATE_MAP[cityKey];
    
    log(`${cityName} için filtre uygulanıyor (Plaka: ${plateCode})`, 'info');
    
    // GeoJSON'daki ilçeleri şehre göre filtrele
    const filtered = {
        type: 'FeatureCollection',
        features: turkeyGeoJSON.features.filter(feature => {
            const props = feature.properties;
            
            // Farklı GeoJSON formatlarına uyum sağla
            const featurePlate = props.il_kodu || props.plate || props.plaka || props.il;
            const featureCity = normalize(props.il_adi || props.city || props.sehir || '');
            
            return featurePlate === plateCode || featureCity === cityKey;
        })
    };
    
    log(`${filtered.features.length} ilçe bulundu`, filtered.features.length > 0 ? 'success' : 'warn');
    
    return filtered.features.length > 0 ? filtered : null;
}

// ============================================
// VERİ YÖNETİMİ
// ============================================
async function loadData() {
    updateStatus('Veriler yükleniyor...', '#f59e0b');
    log('Veri çekme başladı', 'info');

    return new Promise((resolve) => {
        Papa.parse(CONFIG.SHEET_URL, {
            download: true,
            header: true,
            complete: (results) => {
                allData = results.data.filter(row => 
                    row.Sehir && row.Ilce && row.Firma && row.Limit
                );
                
                if (allData.length > 0) {
                    updateStatus(`${allData.length} kayıt yüklendi`, '#22c55e');
                    log(`${allData.length} kayıt yüklendi`, 'success');
                    resolve(true);
                } else {
                    updateStatus('Veri yüklenemedi!', '#ef4444');
                    log('Geçerli veri bulunamadı', 'error');
                    resolve(false);
                }
            },
            error: (error) => {
                updateStatus('Bağlantı hatası!', '#ef4444');
                log(`Hata: ${error.message}`, 'error');
                resolve(false);
            }
        });
    });
}

function getCities() {
    return [...new Set(allData.map(row => row.Sehir.trim()))].sort();
}

function getDistrictFirms(cityName, districtName) {
    const cityKey = normalize(cityName);
    const districtKey = normalize(districtName);
    
    return allData
        .filter(row => 
            normalize(row.Sehir) === cityKey && 
            normalize(row.Ilce) === districtKey
        )
        .map(row => ({
            Firma: row.Firma.trim(),
            Limit: parseInt(row.Limit) || 999
        }));
}

function getMinLimit(cityName, districtName) {
    const firms = getDistrictFirms(cityName, districtName);
    if (firms.length === 0) return null;
    return Math.min(...firms.map(f => f.Limit));
}

// ============================================
// HARİTA FONKSİYONLARI
// ============================================
function createMap() {
    map = L.map('map').setView(CONFIG.MAP_CENTER, CONFIG.MAP_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap',
        maxZoom: 18
    }).addTo(map);
    log('Harita oluşturuldu', 'info');
}

function renderCityList() {
    const cities = getCities();
    const container = document.getElementById('cityList');
    container.innerHTML = '';
    
    cities.forEach(city => {
        const card = document.createElement('div');
        card.className = 'city-card';
        card.textContent = city.toUpperCase();
        card.onclick = () => loadCityMap(city);
        container.appendChild(card);
    });
    
    log(`${cities.length} şehir listelendi`, 'info');
}

async function loadCityMap(cityName) {
    // Önceki katmanı temizle
    if (currentLayer) {
        map.removeLayer(currentLayer);
        currentLayer = null;
    }
    
    log(`${cityName} haritası yükleniyor`, 'info');
    showLoading(true);
    
    try {
        // Master GeoJSON'ı yükle (ilk seferden sonra cache'ten gelir)
        await loadTurkeyGeoJSON();
        
        // Sadece o şehrin ilçelerini filtrele
        const cityGeoJSON = filterGeoJSONByCity(cityName);
        
        if (!cityGeoJSON || cityGeoJSON.features.length === 0) {
            showLoading(false);
            alert(`${cityName} için harita verisi bulunamadı. GeoJSON formatı uyumsuz olabilir.`);
            log(`${cityName} için veri bulunamadı`, 'error');
            return;
        }
        
        // Haritayı çiz
        currentLayer = L.geoJSON(cityGeoJSON, {
            style: (feature) => {
                const district = feature.properties.ilce_adi || feature.properties.name || feature.properties.ilce || '';
                const minLimit = getMinLimit(cityName, district);
                
                return {
                    fillColor: minLimit ? getColor(minLimit) : CONFIG.COLORS.NO_DATA,
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    fillOpacity: 0.7
                };
            },
            onEachFeature: (feature, layer) => {
                const district = feature.properties.ilce_adi || feature.properties.name || feature.properties.ilce || 'Bilinmiyor';
                const firms = getDistrictFirms(cityName, district);
                
                let popup = `<div style="font-family:sans-serif; min-width:250px;">
                    <h3 style="margin:0 0 12px; color:#1e293b; font-size:17px; font-weight:700;">${district}</h3>`;
                
                if (firms.length === 0) {
                    popup += '<p style="color:#94a3b8; font-style:italic;">Bu bölgede hizmet yok</p>';
                } else {
                    firms.forEach(f => {
                        const color = getColor(f.Limit);
                        popup += `<div style="margin:8px 0; padding:10px; background:#f8fafc; border-radius:8px; border-left:3px solid ${color};">
                            <strong style="color:#334155;">${f.Firma}</strong><br>
                            <span style="color:${color}; font-weight:700;">Minimum ${f.Limit} kişi</span>
                        </div>`;
                    });
                }
                
                popup += '</div>';
                layer.bindPopup(popup);
                
                // Hover efekti
                layer.on({
                    mouseover: (e) => e.target.setStyle({ weight: 3, fillOpacity: 0.9 }),
                    mouseout: (e) => currentLayer.resetStyle(e.target)
                });
            }
        }).addTo(map);
        
        map.fitBounds(currentLayer.getBounds());
        document.getElementById('backButton').classList.remove('hidden');
        showLoading(false);
        log(`${cityName} haritası yüklendi`, 'success');
        
    } catch (error) {
        showLoading(false);
        alert('Harita yüklenirken hata oluştu!');
        log(`Harita hatası: ${error.message}`, 'error');
    }
}

function resetMap() {
    if (currentLayer) {
        map.removeLayer(currentLayer);
        currentLayer = null;
    }
    map.setView(CONFIG.MAP_CENTER, CONFIG.MAP_ZOOM);
    document.getElementById('backButton').classList.add('hidden');
    log('Türkiye geneline dönüldü', 'info');
}

// ============================================
// BAŞLATMA
// ============================================
async function init() {
    log('Uygulama başlatılıyor', 'info');
    
    createMap();
    
    const success = await loadData();
    
    if (success) {
        renderCityList();
        document.getElementById('backButton').onclick = resetMap;
        log('Uygulama hazır!', 'success');
    }
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
