<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YMK Catering - İnteraktif Harita</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body,html{margin:0;padding:0;height:100%;font-family:'Inter',sans-serif;display:flex;overflow:hidden;}
        #sidebar{width:360px;background:#fff;border-right:1px solid #e2e8f0;padding:24px;overflow-y:auto;}
        #map{flex:1;}
        h1{font-size:24px;margin:0;color:#1e293b;}
        .subtitle{color:#16a34a;font-weight:600;font-size:14px;}
        .sehir-item{padding:14px 16px;background:#f8fafc;border-radius:10px;margin:10px 0;cursor:pointer;font-weight:600;transition:.2s;}
        .sehir-item:hover{background:#dbeafe;transform:translateX(6px);}
        .back-btn{padding:10px 20px;background:#1e40af;color:#fff;border:none;border-radius:8px;cursor:pointer;margin:20px 0;font-weight:600;}
        .hidden{display:none;}
    </style>
</head>
<body>

<div id="sidebar">
    <h1>YMK Catering</h1>
    <div class="subtitle">İnteraktif Operasyon Haritası – CANLI</div>
    <button id="backBtn" class="back-btn hidden">Türkiye Geneli</button>
    <div id="sehirListesi" style="margin-top:30px;"></div>
</div>

<div id="map"></div>

<script>
    const SHEET_URL = 'https://docs.google.com/spreadsheets/d/14v85yx696A2-5L3WWc5LTnBCwc6esA68Roh8Wo7uleI/gviz/tq?tqx=out:csv';
    let veri = [], map, currentLayer;

    // Harita başlatılıyor (TEK SATIR, HATA YOK)
    map = L.map('map').setView([39.0, 35.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
    }).addTo(map);

    function temizle(str) {
        if (!str) return '';
        return str.toLowerCase()
            .replace(/ğ/g,'g').replace(/ü/g,'u').replace(/ş/g,'s')
            .replace(/ı/g,'i').replace(/ö/g,'o').replace(/ç/g,'c')
            .replace(/[^a-z0-9]/g,'');
    }

    function renk(limit) {
        limit = parseInt(limit);
        if (limit <= 15) return "#22c55e";
        if (limit <= 50) return "#f59e0b";
        return "#ef4444";
    }

    async function sehriAc(sehir) {
        const kod = temizle(sehir);
        if (currentLayer) map.removeLayer(currentLayer);

        const dosya = kod === "istanbul" ? "istanbul.json" : null;
        if (!dosya) {
            alert("Bu şehir için harita dosyası henüz yok. Sadece İstanbul aktif.");
            return;
        }

        try {
            const resp = await fetch(dosya);
            const geojson = await resp.json();

            currentLayer = L.geoJSON(geojson, {
                style: feature => {
                    const ilce = feature.properties.name || feature.properties.NAME || feature.properties.ilce;
                    const limits = veri
                        .filter(r => temizle(r.Sehir) === kod && temizle(r.Ilce) === temizle(ilce))
                        .map(r => parseInt(r.Limit) || 9999);
                    const enDusuk = limits.length ? Math.min(...limits) : null;

                    return {
                        fillColor: enDusuk ? renk(enDusuk) : "#cbd5e1",
                        weight: 1.8,
                        color: "white",
                        fillOpacity: 0.8
                    };
                },
                onEachFeature: (feature, layer) => {
                    const ilce = feature.properties.name || feature.properties.NAME || feature.properties.ilce;
                    const firmalar = veri.filter(r => temizle(r.Sehir)===kod && temizle(r.Ilce)===temizle(ilce));
                    if (firmalar.length === 0) return;

                    let html = `<b style="font-size:16px">${ilce.toUpperCase()}</b><hr>`;
                    firmalar.forEach(f => {
                        html += `<div><b>${f.Firma}</b>: <span style="color:${renk(f.Limit)}">Min ${f.Limit} kişi</span></div>`;
                    });
                    layer.bindPopup(html);
                }
            }).addTo(map);

            map.fitBounds(currentLayer.getBounds());
            document.getElementById("backBtn").classList.remove("hidden");
        } catch (e) {
            console.error(e);
            alert("Harita dosyası yüklenemedi.");
        }
    }

    // Veri çek
    Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        complete: function(res) {
            veri = res.data.filter(r => r.Sehir && r.Ilce && r.Firma && r.Limit?.trim());
            const sehirler = [...new Set(veri.map(r => r.Sehir.trim()))].sort();

            const liste = document.getElementById("sehirListesi");
            sehirler.forEach(s => {
                const div = document.createElement("div");
                div.className = "sehir-item";
                div.textContent = s.toUpperCase();
                div.onclick = () => sehriAc(s);
                liste.appendChild(div);
            });
        }
    });

    // Geri butonu
    document.getElementById("backBtn").onclick = () => {
        if (currentLayer) map.removeLayer(currentLayer);
        map.setView([39.0, 35.0], 6);
        document.getElementById("backBtn").classList.add("hidden");
    };
</script>
</body>
</html>
