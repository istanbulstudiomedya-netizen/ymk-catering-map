<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YMK Catering - Operasyon Paneli</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
            background: #f8fafc;
        }
        
        #sidebar {
            width: 400px;
            background: white;
            border-right: 2px solid #e2e8f0;
            padding: 24px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.08);
        }
        
        .brand h1 {
            font-size: 28px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 4px;
        }
        
        .subtitle {
            font-size: 13px;
            font-weight: 600;
            color: #22c55e;
            display: block;
            margin-bottom: 24px;
        }
        
        .back-btn {
            width: 100%;
            padding: 12px;
            background: #1e40af;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
            transition: 0.2s;
        }
        
        .back-btn:hover {
            background: #1e3a8a;
        }
        
        .hidden { display: none !important; }
        
        .status-card {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .status-label {
            font-size: 12px;
            font-weight: 600;
            color: #475569;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        
        .status-value {
            font-size: 15px;
            font-weight: 700;
            color: #1e40af;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 12px;
        }
        
        .city-card {
            padding: 16px 18px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            margin: 8px 0;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .city-card:hover {
            background: #dbeafe;
            border-color: #1e40af;
            transform: translateX(6px);
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.15);
        }
        
        .city-card.map-available::after {
            content: 'üó∫Ô∏è';
            font-size: 18px;
        }
        
        .city-card.list-only::after {
            content: 'üìã';
            font-size: 18px;
        }
        
        .legend-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
        }
        
        .legend-title {
            font-size: 13px;
            font-weight: 700;
            color: #0f172a;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 8px 0;
            font-size: 14px;
            color: #475569;
        }
        
        .legend-dot {
            width: 28px;
            height: 20px;
            border-radius: 6px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        #mapContainer {
            flex: 1;
            position: relative;
            background: #e0f2fe;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        #detailView {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            padding: 40px;
            overflow-y: auto;
        }
        
        .detail-header {
            margin-bottom: 30px;
        }
        
        .detail-title {
            font-size: 32px;
            font-weight: 700;
            color: #0f172a;
            margin-bottom: 8px;
        }
        
        .detail-subtitle {
            font-size: 16px;
            color: #64748b;
        }
        
        .district-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid #1e40af;
        }
        
        .district-name {
            font-size: 18px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 12px;
        }
        
        .firm-item {
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e2e8f0;
        }
        
        .firm-name {
            font-weight: 600;
            color: #334155;
        }
        
        .firm-limit {
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .limit-low { background: #dcfce7; color: #166534; }
        .limit-medium { background: #fef3c7; color: #92400e; }
        .limit-high { background: #fee2e2; color: #991b1b; }
        
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }
        
        .leaflet-popup-content {
            margin: 16px;
            font-family: inherit;
        }
        
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 40%; border-right: none; border-bottom: 2px solid #e2e8f0; }
            #mapContainer { height: 60%; }
        }
    </style>
</head>
<body>

<aside id="sidebar">
    <header class="brand">
        <h1>YMK Catering</h1>
        <span class="subtitle">Operasyon Y√∂netim Sistemi ‚úì</span>
    </header>

    <button id="backButton" class="back-btn hidden">‚Üê Ana Sayfa</button>

    <div class="status-card">
        <div class="status-label">Sistem Durumu</div>
        <div id="systemStatus" class="status-value">Ba≈ülatƒ±lƒ±yor...</div>
    </div>

    <div>
        <h2 class="section-title">≈ûehirler</h2>
        <div id="cityList">
            <div style="text-align:center; padding:40px; color:#94a3b8;">Y√ºkleniyor...</div>
        </div>
    </div>

    <div class="legend-card">
        <h3 class="legend-title">Minimum Sipari≈ü Limitleri</h3>
        <div>
            <div class="legend-item">
                <span class="legend-dot" style="background:#22c55e"></span>
                <span>0-15 ki≈üi</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot" style="background:#f59e0b"></span>
                <span>16-50 ki≈üi</span>
            </div>
            <div class="legend-item">
                <span class="legend-dot" style="background:#ef4444"></span>
                <span>51+ ki≈üi</span>
            </div>
        </div>
    </div>
</aside>

<main id="mapContainer">
    <div id="map"></div>
    <div id="detailView" class="hidden"></div>
</main>

<script>
// ============================================
// YAPILANDIRMA
// ============================================
const CONFIG = {
    SHEET_URL: 'https://docs.google.com/spreadsheets/d/14v85yx696A2-5L3WWc5LTnBCwc6esA68Roh8Wo7uleI/gviz/tq?tqx=out:csv',
    
    // HARƒ∞TASI OLAN ≈ûEHƒ∞RLER
    CITIES_WITH_MAP: {
        'istanbul': 'istanbul.json'
        // ƒ∞leriye y√∂nelik: 'ankara': 'ankara.json'
    },
    
    MAP_CENTER: [39.0, 35.0],
    MAP_ZOOM: 6
};

// ============================================
// GLOBAL DEƒûƒ∞≈ûKENLER
// ============================================
let map = null;
let currentLayer = null;
let allData = [];
let viewMode = 'map'; // 'map' veya 'list'

// ============================================
// YARDIMCI FONKSƒ∞YONLAR
// ============================================
function normalize(text) {
    if (!text) return '';
    return text.toString().toLowerCase().trim()
        .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's')
        .replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
        .replace(/[^a-z0-9]/g, '');
}

function getColor(limit) {
    const num = parseInt(limit);
    if (num <= 15) return '#22c55e';
    if (num <= 50) return '#f59e0b';
    return '#ef4444';
}

function getLimitClass(limit) {
    const num = parseInt(limit);
    if (num <= 15) return 'limit-low';
    if (num <= 50) return 'limit-medium';
    return 'limit-high';
}

function updateStatus(message, color = '#f59e0b') {
    const el = document.getElementById('systemStatus');
    if (el) {
        el.textContent = message;
        el.style.color = color;
    }
}

function log(message, type = 'info') {
    const colors = { info: '#3b82f6', success: '#22c55e', error: '#ef4444', warn: '#f59e0b' };
    console.log(`%c[YMK] ${message}`, `color: ${colors[type]}; font-weight: bold`);
}

// ============================================
// VERƒ∞ Y√ñNETƒ∞Mƒ∞
// ============================================
async function loadData() {
    updateStatus('Veriler y√ºkleniyor...', '#f59e0b');
    log('Veri √ßekme ba≈üladƒ±', 'info');

    return new Promise((resolve) => {
        Papa.parse(CONFIG.SHEET_URL, {
            download: true,
            header: true,
            complete: (results) => {
                allData = results.data.filter(row => 
                    row.Sehir && row.Ilce && row.Firma && row.Limit
                );
                
                if (allData.length > 0) {
                    updateStatus(`${allData.length} kayƒ±t y√ºklendi`, '#22c55e');
                    log(`${allData.length} kayƒ±t y√ºklendi`, 'success');
                    resolve(true);
                } else {
                    updateStatus('Veri y√ºklenemedi!', '#ef4444');
                    resolve(false);
                }
            },
            error: () => {
                updateStatus('Baƒülantƒ± hatasƒ±!', '#ef4444');
                resolve(false);
            }
        });
    });
}

function getCities() {
    return [...new Set(allData.map(row => row.Sehir.trim()))].sort();
}

function getCityData(cityName) {
    const cityKey = normalize(cityName);
    const cityData = {};
    
    allData.forEach(row => {
        if (normalize(row.Sehir) === cityKey) {
            const district = row.Ilce.trim();
            if (!cityData[district]) {
                cityData[district] = [];
            }
            cityData[district].push({
                Firma: row.Firma.trim(),
                Limit: parseInt(row.Limit) || 999
            });
        }
    });
    
    return cityData;
}

function getDistrictFirms(cityName, districtName) {
    const cityKey = normalize(cityName);
    const districtKey = normalize(districtName);
    
    return allData
        .filter(row => 
            normalize(row.Sehir) === cityKey && 
            normalize(row.Ilce) === districtKey
        )
        .map(row => ({
            Firma: row.Firma.trim(),
            Limit: parseInt(row.Limit) || 999
        }));
}

function getMinLimit(cityName, districtName) {
    const firms = getDistrictFirms(cityName, districtName);
    if (firms.length === 0) return null;
    return Math.min(...firms.map(f => f.Limit));
}

// ============================================
// HARƒ∞TA FONKSƒ∞YONLARI
// ============================================
function createMap() {
    map = L.map('map').setView(CONFIG.MAP_CENTER, CONFIG.MAP_ZOOM);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 18
    }).addTo(map);
    log('Harita olu≈üturuldu', 'info');
}

function renderCityList() {
    const cities = getCities();
    const container = document.getElementById('cityList');
    container.innerHTML = '';
    
    cities.forEach(city => {
        const cityKey = normalize(city);
        const hasMap = CONFIG.CITIES_WITH_MAP[cityKey];
        
        const card = document.createElement('div');
        card.className = `city-card ${hasMap ? 'map-available' : 'list-only'}`;
        card.textContent = city.toUpperCase();
        card.onclick = () => loadCity(city);
        container.appendChild(card);
    });
    
    log(`${cities.length} ≈üehir listelendi`, 'info');
}

async function loadCity(cityName) {
    const cityKey = normalize(cityName);
    const mapFile = CONFIG.CITIES_WITH_MAP[cityKey];
    
    if (mapFile) {
        await loadCityMap(cityName, mapFile);
    } else {
        showCityDetail(cityName);
    }
}

async function loadCityMap(cityName, mapFile) {
    log(`${cityName} haritasƒ± y√ºkleniyor`, 'info');
    
    // √ñnceki katmanƒ± temizle
    if (currentLayer) {
        map.removeLayer(currentLayer);
        currentLayer = null;
    }
    
    // Detail view'ƒ± gizle
    document.getElementById('detailView').classList.add('hidden');
    viewMode = 'map';
    
    try {
        const response = await fetch(mapFile);
        if (!response.ok) throw new Error('Dosya bulunamadƒ±');
        
        const geojson = await response.json();
        
        currentLayer = L.geoJSON(geojson, {
            style: (feature) => {
                const district = feature.properties.name || feature.properties.NAME || feature.properties.ilce || '';
                const minLimit = getMinLimit(cityName, district);
                
                return {
                    fillColor: minLimit ? getColor(minLimit) : '#cbd5e1',
                    weight: 2,
                    opacity: 1,
                    color: 'white',
                    fillOpacity: 0.7
                };
            },
            onEachFeature: (feature, layer) => {
                const district = feature.properties.name || feature.properties.NAME || feature.properties.ilce || 'Bilinmiyor';
                const firms = getDistrictFirms(cityName, district);
                
                let popup = `<div style="font-family:sans-serif; min-width:250px;">
                    <h3 style="margin:0 0 12px; color:#1e293b; font-size:17px; font-weight:700;">${district}</h3>`;
                
                if (firms.length === 0) {
                    popup += '<p style="color:#94a3b8; font-style:italic;">Bu b√∂lgede hizmet yok</p>';
                } else {
                    firms.forEach(f => {
                        const color = getColor(f.Limit);
                        popup += `<div style="margin:8px 0; padding:10px; background:#f8fafc; border-radius:8px; border-left:3px solid ${color};">
                            <strong style="color:#334155;">${f.Firma}</strong><br>
                            <span style="color:${color}; font-weight:700;">Min ${f.Limit} ki≈üi</span>
                        </div>`;
                    });
                }
                
                popup += '</div>';
                layer.bindPopup(popup);
                
                layer.on({
                    mouseover: (e) => e.target.setStyle({ weight: 3, fillOpacity: 0.9 }),
                    mouseout: (e) => currentLayer.resetStyle(e.target)
                });
            }
        }).addTo(map);
        
        map.fitBounds(currentLayer.getBounds());
        document.getElementById('backButton').classList.remove('hidden');
        log(`${cityName} haritasƒ± y√ºklendi`, 'success');
        
    } catch (error) {
        log(`Harita hatasƒ±: ${error.message}`, 'error');
        // Harita ba≈üarƒ±sƒ±z olursa liste g√∂ster
        showCityDetail(cityName);
    }
}

function showCityDetail(cityName) {
    log(`${cityName} detay listesi g√∂steriliyor`, 'info');
    
    viewMode = 'list';
    
    // Haritayƒ± gizle
    if (currentLayer) {
        map.removeLayer(currentLayer);
        currentLayer = null;
    }
    
    // Detail view'ƒ± g√∂ster
    const detailView = document.getElementById('detailView');
    detailView.classList.remove('hidden');
    
    const cityData = getCityData(cityName);
    const districts = Object.keys(cityData).sort();
    
    let html = `
        <div class="detail-header">
            <div class="detail-title">${cityName.toUpperCase()}</div>
            <div class="detail-subtitle">${districts.length} il√ßede ${allData.filter(r => normalize(r.Sehir) === normalize(cityName)).length} hizmet noktasƒ±</div>
        </div>
    `;
    
    districts.forEach(district => {
        const firms = cityData[district].sort((a, b) => a.Limit - b.Limit);
        
        html += `
            <div class="district-section">
                <div class="district-name">${district}</div>
        `;
        
        firms.forEach(firm => {
            html += `
                <div class="firm-item">
                    <span class="firm-name">${firm.Firma}</span>
                    <span class="firm-limit ${getLimitClass(firm.Limit)}">Min ${firm.Limit} ki≈üi</span>
                </div>
            `;
        });
        
        html += '</div>';
    });
    
    detailView.innerHTML = html;
    document.getElementById('backButton').classList.remove('hidden');
}

function resetView() {
    if (currentLayer) {
        map.removeLayer(currentLayer);
        currentLayer = null;
    }
    
    document.getElementById('detailView').classList.add('hidden');
    map.setView(CONFIG.MAP_CENTER, CONFIG.MAP_ZOOM);
    document.getElementById('backButton').classList.add('hidden');
    viewMode = 'map';
    
    log('Ana sayfaya d√∂n√ºld√º', 'info');
}

// ============================================
// BA≈ûLATMA
// ============================================
async function init() {
    log('Uygulama ba≈ülatƒ±lƒ±yor', 'info');
    
    createMap();
    
    const success = await loadData();
    
    if (success) {
        renderCityList();
        document.getElementById('backButton').onclick = resetView;
        log('Uygulama hazƒ±r!', 'success');
    }
}

document.addEventListener('DOMContentLoaded', init);
</script>

</body>
</html>
