<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>YMK Catering - Veri YÃ¶netim Paneli</title>
    <!-- HARÄ°TA KÃœTÃœPHANESÄ°NÄ° SÄ°LDÄ°K, ARTIK SADECE VERÄ° YÃ–NETÄ°MÄ° -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        body { margin: 0; font-family: 'Inter', sans-serif; background: #f8fafc; display: flex; height: 100vh; }
        #sidebar { width: 380px; background: #fff; border-right: 1px solid #e2e8f0; padding: 25px; display: flex; flex-direction: column; z-index: 20; box-shadow: 4px 0 20px rgba(0,0,0,0.05); }
        
        #map-container { flex-grow: 1; position: relative; background: #e2e8f0; /* Harita yerine gri alan */ }
        #map-placeholder { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            text-align: center; color: #64748b; font-size: 14px; 
        }

        /* ... DiÄŸer CSS kodlarÄ± ... */
        h1 { font-size: 20px; color: #0f172a; margin: 0; font-weight: 800; }
        .subtitle { font-size: 12px; color: #64748b; margin-bottom: 20px; display:block; }
        #sehir-detay-kutusu { background: #f8fafc; border-radius: 8px; padding: 15px; border: 1px solid #e2e8f0; margin-top: 15px; max-height: 400px; overflow-y: auto; }
        .min-pax { font-weight: bold; color: #10b981; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="brand">
            <h1>YMK Catering</h1>
            <span class="subtitle">Veri YÃ¶netim Paneli (HaritasÄ±z) ğŸŸ¢</span>
        </div>

        <button id="backBtn" onclick="turkiyeModunaDon()" class="hidden">â† TÃ¼rkiye HaritasÄ± Verilerine DÃ¶n</button>

        <!-- ÅEHÄ°R DETAY VEYA Ä°STANBUL HARÄ°TASI KONTROLLERÄ° -->
        <div id="city-controls" class="hidden">
            <h2 id="aktif-sehir-baslik" style="font-size:16px; margin:0 0 10px 0; color:#0f172a;">Åehir DetayÄ±</h2>
            
            <div id="sehir-detay-kutusu">
                <span class="legend-title" style="margin-bottom:10px;">BÃ–LGESEL HÄ°ZMET KURALLARI</span>
                <span id="detay-icerik">Bu ÅŸehirdeki ilÃ§e bazlÄ± minimum sipariÅŸ kurallarÄ± buraya gelecek.</span>
            </div>
        </div>
        
        <!-- TÃœRKÄ°YE MODU -->
        <div id="turkiye-info">
            <div class="legend-box">
                <span class="legend-title">SÄ°STEM DURUMU</span>
                <div style="font-size: 13px; color: #334155;">
                    <div style="margin-bottom:5px">ğŸ“Š Excel: <strong>BaÄŸlÄ±</strong></div>
                    <div id="toplam-sehir-sayisi">â³ Veriler yÃ¼kleniyor...</div>
                </div>
            </div>
            <div style="margin-top:20px;">
                <span style="font-size:12px; font-weight:bold; color:#0f172a;">AKTÄ°F OPERASYON ÅEHÄ°RLERÄ°:</span>
                <div id="aktif-sehirler-listesi" class="sehir-listesi"></div>
            </div>
        </div>
    </div>

    <!-- HARÄ°TA YERÄ°NE GRÄ° KUTU KOYDUK -->
    <div id="map-container">
        <div id="map-placeholder">
            <h1>HARÄ°TA YÃœKLEME KÄ°TLERÄ° SÄ°LÄ°NDÄ°</h1>
            <p>Bu alan, teknik sorunlar nedeniyle haritasÄ±z olarak ayarlandÄ±.<br>
            Sol menÃ¼den ÅŸehire tÄ±klayarak veri panelini kullanabilirsiniz.</p>
        </div>
    </div>

    <script>
        const GOOGLE_SHEET_LINKI = 'https://docs.google.com/spreadsheets/d/14v85yx696A2-5L3WWc5LTnBCwc6esA68Roh8Wo7uleI/gviz/tq?tqx=out:csv';

        let tumVeriler = []; 
        let aktifSehirlerSet = new Set(); 

        function temizle(txt) {
            if(!txt) return "";
            return txt.toLocaleLowerCase('tr-TR').replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u').replace(/ÅŸ/g,'s').replace(/Ä±/g,'i').replace(/Ã¶/g,'o').replace(/Ã§/g,'c').trim();
        }

        // 1. EXCEL VERÄ°SÄ°NÄ° Ã‡EK
        function verileriYukle() {
            Papa.parse(GOOGLE_SHEET_LINKI, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    tumVeriler = results.data;
                    tumVeriler.forEach(satir => {
                        if(satir.Sehir) aktifSehirlerSet.add(temizle(satir.Sehir));
                    });
                    
                    listeyiGuncelle();
                },
                error: function() { alert("Excel baÄŸlantÄ±sÄ± bozuk."); }
            });
        }

        // 2. DETAY AÃ‡MA FONKSÄ°YONU (SADECE LÄ°STE AÃ‡AR)
        function detaylariAc(sehirAdi) {
            const temizAd = temizle(sehirAdi);
            document.getElementById('turkiye-info').classList.add('hidden');
            document.getElementById('city-controls').classList.remove('hidden');
            document.getElementById('backBtn').classList.remove('hidden');
            document.getElementById('aktif-sehir-baslik').innerText = sehirAdi + " - Min. SipariÅŸ Analizi";

            // Listeyi doldur
            listeyiDoldur(temizAd); 
        }

        // 3. LÄ°STE DOLDURMA (Ankara/Ä°zmir vb. iÃ§in)
        function listeyiDoldur(sehirKod) {
            const detayIcerik = document.getElementById('detay-icerik');
            detayIcerik.innerHTML = '';
            
            let firmalarListesi = {};
            tumVeriler.forEach(satir => {
                if(temizle(satir.Sehir) === sehirKod && satir.Ilce) {
                    if (!firmalarListesi[satir.Firma]) firmalarListesi[satir.Firma] = [];
                    firmalarListesi[satir.Firma].push({Ilce: satir.Ilce, Limit: satir.Limit});
                }
            });

            Object.keys(firmalarListesi).sort().forEach(firmaAdi => {
                let html = `<div class="detay-firma-baslik">${firmaAdi}</div>`;
                firmalarListesi[firmaAdi].sort((a, b) => a.Ilce.localeCompare(b.Ilce)).forEach(detay => {
                    html += `<div class="detay-kural"><span>${detay.Ilce}</span> <span class="min-pax">Min ${detay.Limit} KiÅŸi</span></div>`;
                });
                detayIcerik.innerHTML += html;
            });

            if (Object.keys(firmalarListesi).length === 0) {
                detayIcerik.innerHTML = `<div style="color:#94a3b8; font-size:13px; text-align:center; padding:20px;">Bu ÅŸehirde henÃ¼z hizmet veriniz yok.</div>`;
            }
        }

        // 4. LÄ°STEYÄ° GÃœNCELLE
        function listeyiGuncelle() {
            const listeDiv = document.getElementById('aktif-sehirler-listesi');
            document.getElementById('toplam-sehir-sayisi').innerText = `ğŸ“Š ${aktifSehirlerSet.size} Åehirde Veri Var`;
            listeDiv.innerHTML = "";
            Array.from(aktifSehirlerSet).sort().forEach(sehir => {
                const gorunenAd = sehir.charAt(0).toUpperCase() + sehir.slice(1);
                const item = document.createElement('div');
                item.className = 'sehir-item';
                item.innerHTML = `<span>${gorunenAd}</span> <span>âœ</span>`;
                item.onclick = () => detaylariAc(sehir);
                listeDiv.appendChild(item);
            });
        }

        // 5. TÃœRKÄ°YE MODUNA DÃ–N (TEMÄ°ZLEME)
        window.turkiyeModunaDon = function() { 
            document.getElementById('city-controls').classList.add('hidden');
            document.getElementById('backBtn').classList.add('hidden');
            document.getElementById('turkiye-info').classList.remove('hidden');
        }

        // BAÅLANGIÃ‡
        verileriYukle();
    </script>
</body>
</html>
